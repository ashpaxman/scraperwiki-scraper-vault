###############################################################################
# START HERE: Tutorial for scraping ASP.NET pages (HTML pages that end .aspx), using the
# very powerful Mechanize library. In general, when you follow a 'next' link on 
# .aspx pages, you're actually submitting a form.
# This tutorial demonstrates scraping a particularly tricky example. 
###############################################################################
require 'rubygems'
require 'nokogiri'
require 'mechanize'
require 'open-uri'

Mechanize.html_parser = Nokogiri::HTML
BASE_URL = 'http://www.bcct.ca/MemberServices/FindATeacher.aspx'

# scrape_table function: gets passed an individual page to scrape (not important for tutorial)
def scrape_table(page_body)
#  data_table = Nokogiri::HTML(page_body).css('table#ProviderSearchResultsTable1_ProvidersGrid tr.SearchResultsRow').collect do |row|
data_table = Nokogiri::HTML(page_body).css('table#dgPublicRegistry tr.headerRegister').collect do |row|

    record = {}
    record['Last Name']           = row.css('td')[0].inner_text
    record['Given Name']            = row.css('td')[1].inner_text
#    record['CurrentRecognitions'] = row.css('td')[2].inner_text.gsub('&nbsp;',' ').rstrip
    ScraperWiki.save(["Teacher"], record)
  end
end
        
# Scrape page, look for 'next' link: if found, submit the page form
def scrape_and_look_for_next_link(page)
    scrape_table(page.body)
    link = page.link_with(:text => '[Next Page]')
    if link
      page.form_with(:name => 'ctl00') do |f|
        f['__EVENTTARGET'] = ''
        f['__EVENTARGUMENT'] = ''
        f['__EVENTVALIDATION'] ='/wEWGwKsy+eJDAKq2a31CQKq2aH4CQKq2cX/CQKq2Zn6CQKq2Z35CQKq2ZHtCQKq2fXrCQLci+T+DQKhyYCRCQLmhp2jBALIos7ZDwKb4OmLAgL9ydTTCAKS2MP4BAKln/PuCgLugdbHCgLtgdbHCgLsgdbHCgLrgdbHCgLqgdbHCgLpgdbHCgLogdbHCgLngdbHCgLvgZbICgLvgZrICgLwgdbHCpYo9YtPk5/fKqtX+uq47r3oDsTe'
        f['__VIEWSTATE'] ='/wEPDwUKLTkzNzQ3NjI5Ng9kFgICAQ9kFgYCAQ9kFhICAQ8WAh4Jb25rZXlkb3duBbEBaWYoZXZlbnQud2hpY2ggfHwgZXZlbnQua2V5Q29kZSl7aWYgKChldmVudC53aGljaCA9PSAxMykgfHwgKGV2ZW50LmtleUNvZGUgPT0gMTMpKSB7ZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ25hdl90b3Bfc2VhcmNoX3N1Ym1pdCcpLmNsaWNrKCk7cmV0dXJuIGZhbHNlO319IGVsc2Uge3JldHVybiB0cnVlfTsgZAIDDxYEHhBDYXVzZXNWYWxpZGF0aW9uaB4FdmFsdWVlZAIFDxYCHgV0aXRsZWVkAgcPFgIfA2VkAgkPFgIfA2VkAgsPFgIfA2VkAg0PFgIfA2VkAg8PFgIfA2VkAhEPFgIfA2VkAgsPFgIeBXN0eWxlBQ5ESVNQTEFZOmJsb2NrOxYGAgcPFgIeB1Zpc2libGVnZAIJDxYCHwVnFgICAQ88KwALAQAPFgweC0FsbG93UGFnaW5nZx4QQ3VycmVudFBhZ2VJbmRleGYeCERhdGFLZXlzFgAeC18hSXRlbUNvdW50AgoeCVBhZ2VDb3VudAKCAh4VXyFEYXRhU291cmNlSXRlbUNvdW50ApIUZBYCZg9kFhQCAg8PZBYKHgdvbmNsaWNrBTpqYXZhc2NyaXB0Ol9fZG9Qb3N0QmFjaygnZGdQdWJsaWNSZWdpc3RyeTpfY3RsMzpfY3RsMCcsJycpHgtvbm1vdXNlb3ZlcgUuaGlnaGxpZ2h0Um93KHRoaXMsIHRydWUsICcjODRBRTQwJywgJyNGRkZGRkYnKR4Kb25tb3VzZW91dAUvaGlnaGxpZ2h0Um93KHRoaXMsIGZhbHNlLCAnIzg0QUU0MCcsICcjRkZGRkZGJykfBAUZYmFja2dyb3VuZC1jb2xvcjojRkZGRkZGOx8DBSFQbGVhc2UgY2xpY2sgZm9yIG1vcmUgaW5mb3JtYXRpb24WDmYPZBYCZg8PFgIeBFRleHQFBzExMzQzNzZkZAIBDw8WAh8PBTJBQUtVICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRkAgIPDxYCHw8FMk1JQ0hBRUwgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGQCAw8PFgIfDwUVVkFMSUQgVG8gSnVuIDMwLCAyMDEyZGQCBA8PFgIfDwUKUHJhY3Rpc2luZ2RkAgUPDxYCHw8FIENlcnRpZmljYXRlIGlzIGluIGdvb2Qgc3RhbmRpbmcuZGQCBg8PFgIfDwVfQ2VydGlmaWNhdGUgY2FuIGJlIHVzZWQgdG8gZ2FpbiBlbXBsb3ltZW50IGluIEJDIGluIGFueSBhcmVhIGZvciB3aGljaCBhIGNlcnRpZmljYXRlIGlzIG5lZWRlZC5kZAIDDw9kFgofDAU6amF2YXNjcmlwdDpfX2RvUG9zdEJhY2soJ2RnUHVibGljUmVnaXN0cnk6X2N0bDQ6X2N0bDAnLCcnKR8NBS5oaWdobGlnaHRSb3codGhpcywgdHJ1ZSwgJyM4NEFFNDAnLCAnI0ZGRkZGRicpHw4FL2hpZ2hsaWdodFJvdyh0aGlzLCBmYWxzZSwgJyM4NEFFNDAnLCAnI0ZGRkZGRicpHwQFGWJhY2tncm91bmQtY29sb3I6I0YwRjdFNjsfAwUhUGxlYXNlIGNsaWNrIGZvciBtb3JlIGluZm9ybWF0aW9uFg5mD2QWAmYPDxYCHw8FBzExMzQxODRkZAIBDw8WAh8PBTJBQUxERVJTICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRkAgIPDxYCHw8FMkpVRFkgQU5ORSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGQCAw8PFgIfDwUVVkFMSUQgVG8gSnVuIDMwLCAyMDEyZGQCBA8PFgIfDwUKUHJhY3Rpc2luZ2RkAgUPDxYCHw8FIENlcnRpZmljYXRlIGlzIGluIGdvb2Qgc3RhbmRpbmcuZGQCBg8PFgIfDwVfQ2VydGlmaWNhdGUgY2FuIGJlIHVzZWQgdG8gZ2FpbiBlbXBsb3ltZW50IGluIEJDIGluIGFueSBhcmVhIGZvciB3aGljaCBhIGNlcnRpZmljYXRlIGlzIG5lZWRlZC5kZAIEDw9kFgofDAU6amF2YXNjcmlwdDpfX2RvUG9zdEJhY2soJ2RnUHVibGljUmVnaXN0cnk6X2N0bDU6X2N0bDAnLCcnKR8NBS5oaWdobGlnaHRSb3codGhpcywgdHJ1ZSwgJyM4NEFFNDAnLCAnI0ZGRkZGRicpHw4FL2hpZ2hsaWdodFJvdyh0aGlzLCBmYWxzZSwgJyM4NEFFNDAnLCAnI0ZGRkZGRicpHwQFGWJhY2tncm91bmQtY29sb3I6I0ZGRkZGRjsfAwUhUGxlYXNlIGNsaWNrIGZvciBtb3JlIGluZm9ybWF0aW9uFg5mD2QWAmYPDxYCHw8FBzEwNTIwNjRkZAIBDw8WAh8PBTJBQUxUTyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRkAgIPDxYCHw8FMkdFUkxJTkRFICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGQCAw8PFgIfDwUVVkFMSUQgVG8gSnVuIDMwLCAyMDEyZGQCBA8PFgIfDwUKUHJhY3Rpc2luZ2RkAgUPDxYCHw8FIENlcnRpZmljYXRlIGlzIGluIGdvb2Qgc3RhbmRpbmcuZGQCBg8PFgIfDwVfQ2VydGlmaWNhdGUgY2FuIGJlIHVzZWQgdG8gZ2FpbiBlbXBsb3ltZW50IGluIEJDIGluIGFueSBhcmVhIGZvciB3aGljaCBhIGNlcnRpZmljYXRlIGlzIG5lZWRlZC5kZAIFDw9kFgofDAU6amF2YXNjcmlwdDpfX2RvUG9zdEJhY2soJ2RnUHVibGljUmVnaXN0cnk6X2N0bDY6X2N0bDAnLCcnKR8NBS5oaWdobGlnaHRSb3codGhpcywgdHJ1ZSwgJyM4NEFFNDAnLCAnI0ZGRkZGRicpHw4FL2hpZ2hsaWdodFJvdyh0aGlzLCBmYWxzZSwgJyM4NEFFNDAnLCAnI0ZGRkZGRicpHwQFGWJhY2tncm91bmQtY29sb3I6I0YwRjdFNjsfAwUhUGxlYXNlIGNsaWNrIGZvciBtb3JlIGluZm9ybWF0aW9uFg5mD2QWAmYPDxYCHw8FBzExNzM3OTRkZAIBDw8WAh8PBTJBQUxUT05FTiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRkAgIPDxYCHw8FMktBUkxBIExPVUlTRSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGQCAw8PFgIfDwUVVkFMSUQgVG8gSnVuIDMwLCAyMDEyZGQCBA8PFgIfDwUKUHJhY3Rpc2luZ2RkAgUPDxYCHw8FIENlcnRpZmljYXRlIGlzIGluIGdvb2Qgc3RhbmRpbmcuZGQCBg8PFgIfDwVfQ2VydGlmaWNhdGUgY2FuIGJlIHVzZWQgdG8gZ2FpbiBlbXBsb3ltZW50IGluIEJDIGluIGFueSBhcmVhIGZvciB3aGljaCBhIGNlcnRpZmljYXRlIGlzIG5lZWRlZC5kZAIGDw9kFgofDAU6amF2YXNjcmlwdDpfX2RvUG9zdEJhY2soJ2RnUHVibGljUmVnaXN0cnk6X2N0bDc6X2N0bDAnLCcnKR8NBS5oaWdobGlnaHRSb3codGhpcywgdHJ1ZSwgJyM4NEFFNDAnLCAnI0ZGRkZGRicpHw4FL2hpZ2hsaWdodFJvdyh0aGlzLCBmYWxzZSwgJyM4NEFFNDAnLCAnI0ZGRkZGRicpHwQFGWJhY2tncm91bmQtY29sb3I6I0ZGRkZGRjsfAwUhUGxlYXNlIGNsaWNrIGZvciBtb3JlIGluZm9ybWF0aW9uFg5mD2QWAmYPDxYCHw8FBzExNTY2MDRkZAIBDw8WAh8PBTJBQVJERU1BICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRkAgIPDxYCHw8FMkVSSUMgSk9ITiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGQCAw8PFgIfDwUVVkFMSUQgVG8gSnVuIDMwLCAyMDEyZGQCBA8PFgIfDwUOTm9uLVByYWN0aXNpbmdkZAIFDw8WAh8PBSBDZXJ0aWZpY2F0ZSBpcyBpbiBnb29kIHN0YW5kaW5nLmRkAgYPDxYCHw8FkAFUaGlzIHRlYWNoZXIgY2Fubm90IGFjY2VwdCBlbXBsb3ltZW50IGFzIGEgdGVhY2hlciBpbiBCQy4gVGhlIGNlcnRpZmljYXRlIGlzIG5vdCB2YWxpZCBmb3IgZW1wbG95bWVudCB1bnRpbCBpdCBpcyB1cGdyYWRlZCB0byBQcmFjdGljaW5nIHN0YXR1cy5kZAIHDw9kFgofDAU6amF2YXNjcmlwdDpfX2RvUG9zdEJhY2soJ2RnUHVibGljUmVnaXN0cnk6X2N0bDg6X2N0bDAnLCcnKR8NBS5oaWdobGlnaHRSb3codGhpcywgdHJ1ZSwgJyM4NEFFNDAnLCAnI0ZGRkZGRicpHw4FL2hpZ2hsaWdodFJvdyh0aGlzLCBmYWxzZSwgJyM4NEFFNDAnLCAnI0ZGRkZGRicpHwQFGWJhY2tncm91bmQtY29sb3I6I0YwRjdFNjsfAwUhUGxlYXNlIGNsaWNrIGZvciBtb3JlIGluZm9ybWF0aW9uFg5mD2QWAmYPDxYCHw8FBzExNjY5MjNkZAIBDw8WAh8PBTJBQVJERU5CVVJHICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRkAgIPDxYCHw8FMk1FTEVOQSBEQVdOICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGQCAw8PFgIfDwUVVkFMSUQgVG8gSnVuIDMwLCAyMDEyZGQCBA8PFgIfDwUOTm9uLVByYWN0aXNpbmdkZAIFDw8WAh8PBSBDZXJ0aWZpY2F0ZSBpcyBpbiBnb29kIHN0YW5kaW5nLmRkAgYPDxYCHw8FkAFUaGlzIHRlYWNoZXIgY2Fubm90IGFjY2VwdCBlbXBsb3ltZW50IGFzIGEgdGVhY2hlciBpbiBCQy4gVGhlIGNlcnRpZmljYXRlIGlzIG5vdCB2YWxpZCBmb3IgZW1wbG95bWVudCB1bnRpbCBpdCBpcyB1cGdyYWRlZCB0byBQcmFjdGljaW5nIHN0YXR1cy5kZAIIDw9kFgofDAU6amF2YXNjcmlwdDpfX2RvUG9zdEJhY2soJ2RnUHVibGljUmVnaXN0cnk6X2N0bDk6X2N0bDAnLCcnKR8NBS5oaWdobGlnaHRSb3codGhpcywgdHJ1ZSwgJyM4NEFFNDAnLCAnI0ZGRkZGRicpHw4FL2hpZ2hsaWdodFJvdyh0aGlzLCBmYWxzZSwgJyM4NEFFNDAnLCAnI0ZGRkZGRicpHwQFGWJhY2tncm91bmQtY29sb3I6I0ZGRkZGRjsfAwUhUGxlYXNlIGNsaWNrIGZvciBtb3JlIGluZm9ybWF0aW9uFg5mD2QWAmYPDxYCHw8FBzExNjM1NzdkZAIBDw8WAh8PBTJBQVJFU0tKT0xEICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRkAgIPDxYCHw8FMk1PTklDQSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGQCAw8PFgIfDwUVVkFMSUQgVG8gSnVuIDMwLCAyMDEyZGQCBA8PFgIfDwUKUHJhY3Rpc2luZ2RkAgUPDxYCHw8FIENlcnRpZmljYXRlIGlzIGluIGdvb2Qgc3RhbmRpbmcuZGQCBg8PFgIfDwVfQ2VydGlmaWNhdGUgY2FuIGJlIHVzZWQgdG8gZ2FpbiBlbXBsb3ltZW50IGluIEJDIGluIGFueSBhcmVhIGZvciB3aGljaCBhIGNlcnRpZmljYXRlIGlzIG5lZWRlZC5kZAIJDw9kFgofDAU7amF2YXNjcmlwdDpfX2RvUG9zdEJhY2soJ2RnUHVibGljUmVnaXN0cnk6X2N0bDEwOl9jdGwwJywnJykfDQUuaGlnaGxpZ2h0Um93KHRoaXMsIHRydWUsICcjODRBRTQwJywgJyNGRkZGRkYnKR8OBS9oaWdobGlnaHRSb3codGhpcywgZmFsc2UsICcjODRBRTQwJywgJyNGRkZGRkYnKR8EBRliYWNrZ3JvdW5kLWNvbG9yOiNGMEY3RTY7HwMFIVBsZWFzZSBjbGljayBmb3IgbW9yZSBpbmZvcm1hdGlvbhYOZg9kFgJmDw8WAh8PBQcxMDM4MTc5ZGQCAQ8PFgIfDwUyQUFSRVNUQUQgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZAICDw8WAh8PBTJCQVJCQVJBIEFOTkUgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRkAgMPDxYCHw8FFVZBTElEIFRvIEp1biAzMCwgMjAxMmRkAgQPDxYCHw8FDk5vbi1QcmFjdGlzaW5nZGQCBQ8PFgIfDwUgQ2VydGlmaWNhdGUgaXMgaW4gZ29vZCBzdGFuZGluZy5kZAIGDw8WAh8PBZABVGhpcyB0ZWFjaGVyIGNhbm5vdCBhY2NlcHQgZW1wbG95bWVudCBhcyBhIHRlYWNoZXIgaW4gQkMuIFRoZSBjZXJ0aWZpY2F0ZSBpcyBub3QgdmFsaWQgZm9yIGVtcGxveW1lbnQgdW50aWwgaXQgaXMgdXBncmFkZWQgdG8gUHJhY3RpY2luZyBzdGF0dXMuZGQCCg8PZBYKHwwFO2phdmFzY3JpcHQ6X19kb1Bvc3RCYWNrKCdkZ1B1YmxpY1JlZ2lzdHJ5Ol9jdGwxMTpfY3RsMCcsJycpHw0FLmhpZ2hsaWdodFJvdyh0aGlzLCB0cnVlLCAnIzg0QUU0MCcsICcjRkZGRkZGJykfDgUvaGlnaGxpZ2h0Um93KHRoaXMsIGZhbHNlLCAnIzg0QUU0MCcsICcjRkZGRkZGJykfBAUZYmFja2dyb3VuZC1jb2xvcjojRkZGRkZGOx8DBSFQbGVhc2UgY2xpY2sgZm9yIG1vcmUgaW5mb3JtYXRpb24WDmYPZBYCZg8PFgIfDwUHMTAyODMwM2RkAgEPDxYCHw8FMkFBUk9OU09OICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGQCAg8PFgIfDwUyUEFVTEEgQUxFWEFORFJBICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZAIDDw8WAh8PBRVWQUxJRCBUbyBKdW4gMzAsIDIwMTJkZAIEDw8WAh8PBQpQcmFjdGlzaW5nZGQCBQ8PFgIfDwUgQ2VydGlmaWNhdGUgaXMgaW4gZ29vZCBzdGFuZGluZy5kZAIGDw8WAh8PBV9DZXJ0aWZpY2F0ZSBjYW4gYmUgdXNlZCB0byBnYWluIGVtcGxveW1lbnQgaW4gQkMgaW4gYW55IGFyZWEgZm9yIHdoaWNoIGEgY2VydGlmaWNhdGUgaXMgbmVlZGVkLmRkAgsPD2QWCh8MBTtqYXZhc2NyaXB0Ol9fZG9Qb3N0QmFjaygnZGdQdWJsaWNSZWdpc3RyeTpfY3RsMTI6X2N0bDAnLCcnKR8NBS5oaWdobGlnaHRSb3codGhpcywgdHJ1ZSwgJyM4NEFFNDAnLCAnI0ZGRkZGRicpHw4FL2hpZ2hsaWdodFJvdyh0aGlzLCBmYWxzZSwgJyM4NEFFNDAnLCAnI0ZGRkZGRicpHwQFGWJhY2tncm91bmQtY29sb3I6I0YwRjdFNjsfAwUhUGxlYXNlIGNsaWNrIGZvciBtb3JlIGluZm9ybWF0aW9uFg5mD2QWAmYPDxYCHw8FBzExMzA5OTNkZAIBDw8WAh8PBTJBQVNFTiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRkAgIPDxYCHw8FMkdFUkFMRCBWSU5DRU5UICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGQCAw8PFgIfDwUVVkFMSUQgVG8gSnVuIDMwLCAyMDEyZGQCBA8PFgIfDwUKUHJhY3Rpc2luZ2RkAgUPDxYCHw8FIENlcnRpZmljYXRlIGlzIGluIGdvb2Qgc3RhbmRpbmcuZGQCBg8PFgIfDwVfQ2VydGlmaWNhdGUgY2FuIGJlIHVzZWQgdG8gZ2FpbiBlbXBsb3ltZW50IGluIEJDIGluIGFueSBhcmVhIGZvciB3aGljaCBhIGNlcnRpZmljYXRlIGlzIG5lZWRlZC5kZAILDw8WAh8PZWRkAg0PFgIfBAUNRElTUExBWTpub25lOxYCAgUPZBYEAgUPZBYCAgEPPCsACwBkAgkPZBYKAgEPDxYCHw9lZGQCAw8PFgIfD2VkZAIFDw8WAh8PZWRkAgcPDxYCHw9lZGQCCQ8PFgIfD2VkZGSBfwSdc7A1xldp2muzW9siX+qIhA=='

        page = f.submit()
      end
    scrape_and_look_for_next_link(page)
    end
end

# ---------------------------------------------------------------------------
# START HERE: setting up Mechanize
# We need to set the user-agent header so the page thinks we're a browser, 
# as otherwise it won't show all the fields we need
# ---------------------------------------------------------------------------

starting_url = BASE_URL + 'PSearchResults.aspx?state=NY&rp='
@br = Mechanize.new { |browser|      # Set the user-agent as Firefox - if the page knows we're Mechanize, it won't return all fields
  browser.user_agent_alias = 'Linux Firefox'
}
page = @br.get(starting_url)
puts page.body
# Have a look at 'page': note the 'onSubmit' JavaScript function that is called when 
# you click on the 'next' link. We'll mimic this in the function above.

# start scraping
scrape_and_look_for_next_link(page)

