import scraperwiki
import mechanize
import lxml.html

base_url = "http://foundationcenter.org/findfunders/990finder/"

br = mechanize.Browser()
# br.set_all_readonly(False)    # allow everything to be written to
br.set_handle_robots(False)   # no robots
br.set_handle_refresh(False)  # can sometimes hang without this
br.addheaders = [('User-agent', 'Mozilla/5.0 (X11; U; Linux i686; en-US; rv:1.9.0.1) Gecko/2008071615 Fedora/3.0.1-1.fc9 Firefox/3.0.1')]

eins = ["272258321", "382293305", "270924352", "237230610", "260692843", "383615610", "386147433", "201420919", "237191203", "382846932", "382182301", "134366595", "383173240", "200964420", "382499962", "200012084", "382292187", "382169114", "382905856", "386107966", "383238046", "382453508", "381532540", "382311012", "383027410", "10712614," "262675713", "810664287", "382445398", "383442776", "383191193", "386088879", "237187083", "113837165", "204981277", "383277549", "383636416", "382723417", "273640626", "382187768", "261526879", "383156877", "364554788", "300511631", "382475513", "382959707", "382957013", "237076750", "383395740", "383145501", "382042021", "382291002", "383303758", "10928393,", "381878759", "382866912", "470880050", "382156255", "382788520", "383096014", "382372753", "382874075", "383076103", "383166965", "237327518", "382192266", "383459416", "382992248", "381416522", "382056072", "421691717", "381357020", "10764818," "203194127", "20648628," "270304043", "382853046", "263315239", "383578634", "386051838", "383627486", "208601943", "382674852", "900440306", "382789162", "382831910", "382638782", "381678260", "382672000", "800463151", "263392128", "262052421", "382791823", "383553373", "141911467", "382615820", "383459715", "611580128", "382492836", "383107666", "50621412," "383600928", "260423456", "421746079", "943440231", "383563561", "452211729", "383064919", "383486156", "383326860", "721615236", "386106297", "382729853", "383576597", "382843769", "381876473", "611587184", "371545979", "611533183", "271927369", "386107997", "300410863", "383529642", "161644941", "452920005", "383038681", "383596101", "383579248", "383256536", "593780469", "383112421", "382567552", "383745401", "382524105", "382683669", "383381895", "134335144", "240804258", "383260651", "383044147", "331099014", "200134991", "383259924", "383252722", "200016596", "721448295", "382436577", "263466288", "201439822", "383262952", "383602992", "383429930", "900395690", "383182046", "753005784", "383008651", "381818068", "432085298", "237105898", "270607089", "383526629", "382994871", "383447370", "270650261", "383541918", "270097769", "800376088", "382364752", "383455896", "237161291", "383422272", "382148261", "383537726", "753254896", "611456602", "386112533", "371461428", "383432913", "522182227", "274605607", "383463868", "300564595", "61769989," "383038785", "383140673", "382248479", "382535519", "273529154", "264514751", "383337055", "383312467", "382549361", "382154991", "382143042", "680656618", "383473095", "383626850", "382699223", "383468772", "386099694", "202948116", "383277264", "382898921", "30488178," "311428704", "381650980", "383375179", "381404585", "205092424", "383524486", "562438797", "386175368", "382127818", "382996365", "20647494," "264452551", "237083832", "272308036", "382529146", "382921913", "382295929", "273398819", "383581720", "383447972", "383046684", "381567740", "383017670", "382766926", "382827795", "382280603", "800391061", "237027766", "383237239", "320098090", "381845857", "383585521", "382995984", "451531857", "382391907", "161744136", "383175180", "201584280", "382946617", "383237414", "383369894", "383496250", "452076358", "331199158", "383637300", "201272745", "271375684", "237025655", "382977401", "262932780", "383500655", "900453362", "205323411", "237310753", "383426719", "161724044", "383197374", "382518142", "270480012", "760821735", "383298295", "300569368", "261693944", "300358909", "800672258", "270526985", "161558160", "237176837", "381374228", "830493936", "320139830", "382203490", "386057206", "383441362", "412156869", "382461622", "571220574", "412184248", "383147105", "271142408", "383788108", "383081615", "382537598", "273849165", "383080909", "382486995", "382410847", "382468662", "382125144", "383134678", "382708025", "412228481", "380508823", "383595752", "383451361", "382773804", "383235146", "383542281", "421733912", "300388998", "451534355", "510149227", "386116069", "237379360", "260418377", "752795250", "383411179", "383207971", "261899228", "382234530", "271683825", "382825768", "582598993", "382305699", "300417630", "382622732", "980376003", "382924910", "237305906", "383584122", "382487626", "383155605", "382327846", "382174124",]


for ein in eins:
    response = br.open(base_url)
    br.form = list(br.forms())[0]  

    br.form['ei']= ein # The ein search form is named "ei"
    response = br.submit()
    r = response.read()

    if "0 documents matched" in str(r):
        print "EIN not found (you've probably searched for a religious group)"
    else:
        html = lxml.html.fromstring(r)
        heading = html.cssselect("h2:contains('TOTAL ASSETS')")[0]       
        table = heading.getparent().getparent().getparent()[1:]
        for el in table:
            name = el[0].text_content().strip()
            pdf_url = el.cssselect('a')[0].attrib['href']
            state = el[1].text_content().strip()
            year = el[2].text_content().strip()
            total_assets = el[3].text_content().strip()
            form = el[4].text_content().strip()
            pages = el[5].text_content().strip()

            data = {'ein':ein, 'name':name, 'pdf_url':pdf_url, 'state':state, 'year':year, 'total_assets':total_assets, 'form':form, 'pages':pages }
            scraperwiki.sqlite.save(['name','year'],data)
            
            
