<?php
$testing = false;

$page = array(
  array("type" => "Sandbox","url" => "http://drupal.org/project/modules/commerce%20-ubercart%20-%22e-commerce%22%20-deprecated%20-uc%20-Ubercart%20-%22Commerce%20Sandbox%22%20-deleted%20-eCommerce?f[0]=bs_project_sandbox%3A1","multiple_results"=>true),
  array("type" => "Sandbox","url" => "http://drupal.org/project/modules/commerce%20-ubercart%20-%22e-commerce%22%20-deprecated%20-uc%20-Ubercart%20-%22Commerce%20Sandbox%22%20-deleted%20-eCommerce?page=1&f[0]=bs_project_sandbox%3A1","multiple_results"=>true),
  array("type" => "Sandbox","url" => "http://drupal.org/project/modules/commerce%20-ubercart%20-%22e-commerce%22%20-deprecated%20-uc%20-Ubercart%20-%22Commerce%20Sandbox%22%20-deleted%20-eCommerce?page=2&f[0]=bs_project_sandbox%3A1","multiple_results"=>true),
  array("type" => "Sandbox","url" => "http://drupal.org/project/modules/commerce%20-ubercart%20-%22e-commerce%22%20-deprecated%20-uc%20-Ubercart%20-%22Commerce%20Sandbox%22%20-deleted%20-eCommerce?page=3&f[0]=bs_project_sandbox%3A1","multiple_results"=>true),
  array("type" => "Sandbox","url" => "http://drupal.org/project/modules/commerce%20-ubercart%20-%22e-commerce%22%20-deprecated%20-uc%20-Ubercart%20-%22Commerce%20Sandbox%22%20-deleted%20-eCommerce?page=4&f[0]=bs_project_sandbox%3A1","multiple_results"=>true),
  array("type" => "Sandbox","url" => "http://drupal.org/project/modules/commerce%20-ubercart%20-%22e-commerce%22%20-deprecated%20-uc%20-Ubercart%20-%22Commerce%20Sandbox%22%20-deleted%20-eCommerce?page=5&f[0]=bs_project_sandbox%3A1","multiple_results"=>true),
  array("type" => "Sandbox","url" => "http://drupal.org/project/modules/commerce%20-ubercart%20-%22e-commerce%22%20-deprecated%20-uc%20-Ubercart%20-%22Commerce%20Sandbox%22%20-deleted%20-eCommerce?page=6&f[0]=bs_project_sandbox%3A1","multiple_results"=>true),
  array("type" => "Sandbox","url" => "http://drupal.org/project/modules/commerce%20-ubercart%20-%22e-commerce%22%20-deprecated%20-uc%20-Ubercart%20-%22Commerce%20Sandbox%22%20-deleted%20-eCommerce?page=7&f[0]=bs_project_sandbox%3A1","multiple_results"=>true),
  array("type" => "Sandbox","url" => "http://drupal.org/project/modules/commerce%20-ubercart%20-%22e-commerce%22%20-deprecated%20-uc%20-Ubercart%20-%22Commerce%20Sandbox%22%20-deleted%20-eCommerce?page=8&f[0]=bs_project_sandbox%3A1","multiple_results"=>true),
  array("type" => "Sandbox","url" => "http://drupal.org/project/modules/commerce%20-ubercart%20-%22e-commerce%22%20-deprecated%20-uc%20-Ubercart%20-%22Commerce%20Sandbox%22%20-deleted%20-eCommerce?page=9&f[0]=bs_project_sandbox%3A1","multiple_results"=>true),
  array("type" => "Sandbox","url" => "http://drupal.org/project/modules/commerce%20-ubercart%20-%22e-commerce%22%20-deprecated%20-uc%20-Ubercart%20-%22Commerce%20Sandbox%22%20-deleted%20-eCommerce?page=10&f[0]=bs_project_sandbox%3A1","multiple_results"=>true),
  array("type" => "Sandbox","url" => "http://drupal.org/project/modules/commerce%20-ubercart%20-%22e-commerce%22%20-deprecated%20-uc%20-Ubercart%20-%22Commerce%20Sandbox%22%20-deleted%20-eCommerce?page=11&f[0]=bs_project_sandbox%3A1","multiple_results"=>true),
  array("type" => "Sandbox","url" => "http://drupal.org/project/modules/commerce%20-ubercart%20-%22e-commerce%22%20-deprecated%20-uc%20-Ubercart%20-%22Commerce%20Sandbox%22%20-deleted%20-eCommerce?page=12&f[0]=bs_project_sandbox%3A1","multiple_results"=>true),
  array("type" => "Distribution","url" => "http://drupal.org/project/distributions/commerce?f[0]=drupal_core%3A103&f[1]=bs_project_sandbox%3A0","multiple_results"=>true),
  array("type" => "Theme","url" => "http://drupal.org/search/site/commerce?f[0]=drupal_core%3A103&f[1]=bs_project_sandbox%3A0&f[2]=ss_meta_type%3Atheme","multiple_results"=>true),
  array("type" => "Module","url" => "http://drupal.org/search/site/commerce?f[0]=drupal_core%3A103&f[1]=bs_project_sandbox%3A0&f[2]=ss_meta_type%3Amodule","multiple_results"=>true),
  array("type" => "Module","url" => "http://drupal.org/search/site/commerce?page=1&f[0]=drupal_core%3A103&f[1]=bs_project_sandbox%3A0&f[2]=ss_meta_type%3Amodule","multiple_results"=>true),
  array("type" => "Module","url" => "http://drupal.org/search/site/commerce?page=2&f[0]=drupal_core%3A103&f[1]=bs_project_sandbox%3A0&f[2]=ss_meta_type%3Amodule","multiple_results"=>true),
  array("type" => "Module","url" => "http://drupal.org/search/site/commerce?page=3&f[0]=drupal_core%3A103&f[1]=bs_project_sandbox%3A0&f[2]=ss_meta_type%3Amodule","multiple_results"=>true),
  array("type" => "Module","url" => "http://drupal.org/search/site/commerce?page=4&f[0]=drupal_core%3A103&f[1]=bs_project_sandbox%3A0&f[2]=ss_meta_type%3Amodule","multiple_results"=>true),
  array("type" => "Module","url" => "http://drupal.org/search/site/commerce?page=5&f[0]=drupal_core%3A103&f[1]=bs_project_sandbox%3A0&f[2]=ss_meta_type%3Amodule","multiple_results"=>true),
  array("type" => "Module","url" => "http://drupal.org/search/site/commerce?page=6&f[0]=drupal_core%3A103&f[1]=bs_project_sandbox%3A0&f[2]=ss_meta_type%3Amodule","multiple_results"=>true),
  array("type" => "Module","url" => "http://drupal.org/search/site/commerce?page=7&f[0]=drupal_core%3A103&f[1]=bs_project_sandbox%3A0&f[2]=ss_meta_type%3Amodule","multiple_results"=>true),
  array("type" => "Module","url" => "http://drupal.org/search/site/commerce?page=8&f[0]=drupal_core%3A103&f[1]=bs_project_sandbox%3A0&f[2]=ss_meta_type%3Amodule","multiple_results"=>true),
  array("type" => "Module","url" => "http://drupal.org/search/site/commerce?page=9&f[0]=drupal_core%3A103&f[1]=bs_project_sandbox%3A0&f[2]=ss_meta_type%3Amodule","multiple_results"=>true),
  array("type" => "Module","url" => "http://drupal.org/search/site/commerce?page=10&f[0]=drupal_core%3A103&f[1]=bs_project_sandbox%3A0&f[2]=ss_meta_type%3Amodule","multiple_results"=>true),
  array("type" => "Module","url" => "http://drupal.org/search/site/commerce?page=11&f[0]=drupal_core%3A103&f[1]=bs_project_sandbox%3A0&f[2]=ss_meta_type%3Amodule","multiple_results"=>true),
  array("type" => "Module","url" => "http://drupal.org/search/site/commerce?page=12&f[0]=drupal_core%3A103&f[1]=bs_project_sandbox%3A0&f[2]=ss_meta_type%3Amodule","multiple_results"=>true),
  array("type" => "Module","url" => "http://drupal.org/search/site/commerce?page=13&f[0]=drupal_core%3A103&f[1]=bs_project_sandbox%3A0&f[2]=ss_meta_type%3Amodule","multiple_results"=>true),
  array("type" => "Module","url" => "http://drupal.org/search/site/commerce?page=14&f[0]=drupal_core%3A103&f[1]=bs_project_sandbox%3A0&f[2]=ss_meta_type%3Amodule","multiple_results"=>true),
  array("type" => "Module","url" => "http://drupal.org/project/inline_entity_form","multiple_results"=>false),
  array("type" => "Module","url" => "http://drupal.org/project/addressfield","multiple_results"=>false),
  array("type" => "Module","url" => "http://drupal.org/project/physical","multiple_results"=>false),
  array("type" => "Module","url" => "http://drupal.org/project/views","multiple_results"=>false),
  array("type" => "Module","url" => "http://drupal.org/project/rules","multiple_results"=>false),
  array("type" => "Module","url" => "http://drupal.org/project/entity","multiple_results"=>false),
  array("type" => "Module","url" => "http://drupal.org/project/tree","multiple_results"=>false),
  array("type" => "Module","url" => "http://drupal.org/project/facetapi","multiple_results"=>false),
  array("type" => "Module","url" => "http://drupal.org/project/search_api","multiple_results"=>false),
  array("type" => "Module","url" => "http://drupal.org/project/editablefields","multiple_results"=>false),
  array("type" => "Module","url" => "http://drupal.org/project/jirafe","multiple_results"=>false),
  array("type" => "Module","url" => "http://drupal.org/project/yottaa","multiple_results"=>false),
  array("type" => "Module","url" => "http://drupal.org/project/dc_cart_ajax","multiple_results"=>false),
  array("type" => "Module","url" => "http://drupal.org/project/commerce_product_clone","multiple_results"=>false),
  array("type" => "Module","url" => "http://drupal.org/project/product_reference_view","multiple_results"=>false),
  array("type" => "Module","url" => "http://drupal.org/project/dc_co_pages","multiple_results"=>false),
  array("type" => "Sandbox","url" => "http://drupal.org/sandbox/webmasterkai/1305710","multiple_results"=>false),
  array("type" => "Sandbox","url" => "http://drupal.org/sandbox/webmasterkai/1313714","multiple_results"=>false),
  array("type" => "Theme","url" => "http://drupal.org/project/corporateclean","multiple_results"=>false),
  array("type" => "Theme","url" => "http://drupal.org/project/bluemasters","multiple_results"=>false),
  array("type" => "Theme","url" => "http://drupal.org/project/sky","multiple_results"=>false),
  array("type" => "Theme","url" => "http://drupal.org/project/business","multiple_results"=>false),
  array("type" => "Theme","url" => "http://drupal.org/project/andromeda","multiple_results"=>false),
  array("type" => "Theme","url" => "http://drupal.org/project/touch","multiple_results"=>false),
  array("type" => "Theme","url" => "http://drupal.org/project/busy","multiple_results"=>false),
  array("type" => "Theme","url" => "http://drupal.org/project/jackson","multiple_results"=>false),
  array("type" => "Module","url" => "http://drupal.org/project/goals","multiple_results"=>false),
  array("type" => "Module","url" => "http://drupal.org/project/rules_linkevent","multiple_results"=>false),
  array("type" => "Module","url" => "http://drupal.org/project/customer_profile_type_ui","multiple_results"=>false)
);       
require 'scraperwiki/simple_html_dom.php';



if ($testing) {
  $limit = 2;
  $Module = 0;
  $Theme = 0;
  $Sandbox = 0;
  $Distribution = 0;

} else {

  // Each run is unique, start fresh (a bit scary)
  if (scraperwiki::table_info('swdata')) {
    scraperwiki::sqliteexecute("drop table swdata");
  }

  // To change schema:
  // - Clear data
  // - Run
  if (!scraperwiki::table_info('swdata')) {
    scraperwiki::sqliteexecute("create table swdata (`module_pg_type` varchar, `name` varchar, `description` text, `url` varchar, `author` varchar, `status` varchar, `modified` datetime, `downloads` int, `installs` int, `bugs` int, `created` datetime, `images` varchar)");
    scraperwiki::sqlitecommit();
  }
  //exit;
}

$now = time();

foreach ($page as $url) {
  if ($testing && !$url['multiple_results'] && $$url['type'] < $limit) {
    echo "We are parsing: ".print_r($url,true)."\n";
    $html = scraperWiki::scrape($url['url']);
    $dom = new simple_html_dom();
    $dom->load($html);
  } elseif (!$testing) {
    $html = scraperWiki::scrape($url['url']);
    $dom = new simple_html_dom();
    $dom->load($html);
  }
  if ($url['multiple_results'] && !$testing) {
    switch ($url['type']) {
      case "Module":
        foreach($dom->find("dt[@class='title'] a") as $data) {
          if (stristr($data->href,"commerce_") || stristr($data->href,"_commerce")) {
            $html2 = scraperWiki::scrape($data->href);
            $dom2 = new simple_html_dom();
            $dom2->load($html2);
            parse_commerce_page($dom2,$data->plaintext,$data->href,$url['type']);
          }
        }
        break;
      case "Theme":
        foreach($dom->find("dt[@class='title'] a") as $data) {
          $html2 = scraperWiki::scrape($data->href);
          $dom2 = new simple_html_dom();
          $dom2->load($html2);
          parse_commerce_page($dom2,$data->plaintext,$data->href,$url['type']);
        }
        break;
      case "Distribution":
        foreach($dom->find("h2[@class='title'] a") as $data) {
          $html2 = scraperWiki::scrape("http://drupal.org".$data->href);
          $dom2 = new simple_html_dom();
          $dom2->load($html2);
          parse_commerce_page($dom2,$data->plaintext,"http://drupal.org".$data->href,$url['type']);
        }
        break;
      case "Sandbox":
        foreach($dom->find("h2[@class='title'] a") as $data) {
          $html2 = scraperWiki::scrape("http://drupal.org".$data->href);
          $dom2 = new simple_html_dom();
          $dom2->load($html2);
          parse_commerce_page($dom2,$data->plaintext,"http://drupal.org".$data->href,$url['type']);
        }
        break;
    } 
  } elseif (!$url['multiple_results']) {
    if ($testing && $$url['type'] < $limit) {
      $$url['type']++;
      echo "Testing a ".$url['type']."\n";
    } elseif ($testing && $$url['type'] >= $limit) {
      continue;
    }
    foreach($dom->find("h1[@id='page-subtitle']") as $data) {
      $title = $data->plaintext;
      if ($url['type']=="Sandbox") {
        $title = explode(":",$title);
        $title = $title[1];
      }
      break;
    }
    if ($testing) { echo "About to parse the ".$url['type']."\n"; }
    parse_commerce_page($dom,$title,$url['url'],$url['type'],$testing);
  }
}

function parse_commerce_page ($dom2,$title,$url,$module_pg_type="Module",$testing=false) {
  global $now;
    
  // author
  $author = "";
  foreach($dom2->find("div[@class='submitted'] a") as $data2){
    $author = $data2->plaintext;
    break;
  }

  // module images
  $module_img = false;
  foreach($dom2->find("div[@class='field-field-project-images'] div[@class='field-item'] a") as $data2) {
    if (!$module_img) $module_img = array();
    //$module_img[] = trim($data2->href);
    $module_img = trim($data2->href);
    break;
  }
  //if ($module_img !== false){
  //  $module_img = implode(", ",$module_img);
  //}

  // created
  $created= NULL;
  foreach($dom2->find("div[@class='submitted'] em") as $data2){
    $created = str_ireplace(' at ', ' ', $data2->plaintext);
    if (!empty($created)) {
      $created = date_create($created);
    }

    break;
  }

  // description
  $desc="";
  foreach($dom2->find("div[@class='node-content'] p") as $data2){
    // get sentences
    $sentences = preg_split('/(?<=[.!?]|[.!?][\'"])\s+/', $data2->plaintext, -1, PREG_SPLIT_NO_EMPTY);
    
    // go through each sentence, avoid if it's the disclaimer or headline, let it iterate to another paragraph
    foreach ($sentences as $sentence) {
      if (
        !stristr(@$sentence,"This is a sandbox project") && 
        !stristr(@$sentence,"Git repository") && 
        strncmp(strtolower($sentence), "overview", 8) !== 0 && 
        strncmp(strtolower($sentence), "description", 11) !== 0 &&
        strlen($desc) < 350){
        $desc .= @$sentence . " ";
      }
    }
    if (strlen($desc) > 350) break;
  }
  $desc = trim($desc);

  // module stats
  $maintenance_status = "";
  $dev_status = "";
  $installs = 0;
  $downloads = 0;
  $lastmodified = "";
  foreach($dom2->find("div[@class='project-info'] ul li") as $data2){
    if (stristr($data2->plaintext,"Maintenance")) {
      $maintenance_status = substr($data2->plaintext,20);
    }
    if (stristr($data2->plaintext,"Development")) {
      $dev_status = substr($data2->plaintext,20);
    }
    if (stristr($data2->plaintext,"Reported")) {
      $array = explode(" ",$data2->plaintext);
      $installs = intval(str_replace(",","",$array[2]));
    }
    if (stristr($data2->plaintext,"Downloads")) {
      $array = explode(" ",$data2->plaintext);
      $downloads = intval(str_replace(",","",$array[1]));
    }
    if (stristr($data2->plaintext,"Last")) {
      $lastmodified = date_create(substr($data2->plaintext,15));
    }
  }

  // Stable releases
  $rec_release = array('version' => '', 'type' => '', 'timestamp' => NULL);      
  foreach($dom2->find("div.download-table-ok tr.views-row-first") as $data2){
    foreach ($data2->find('td.views-field-version a') as $release_data) {
      $rec_release['version'] = $release_data->plaintext;
      // resolve type of release
      //7.x-1.0-beta4
      $version_parts = explode('-', $rec_release['version']);
      if (!empty($version_parts)) {
        $rec_release['type'] = 'unknown';
        $version_parts_count = count($version_parts);
        if (count($version_parts) > 2) {
          $last_version_part = $version_parts[$version_parts_count - 1];
          foreach (array('beta', 'alpha', 'rc') as $version_type) {
            if (stripos($last_version_part, $version_type) !== FALSE) {
              $rec_release['type'] = $version_type;
              break;
            }
          }
        }
        else {
         $rec_release['type'] = 'stable';
        }
      }

      break;
    }
    foreach ($data2->find('td.views-field-file-timestamp') as $release_data) {
      $rec_release['timestamp'] = date_create($release_data->plaintext);
      break;
    }

    break;
  }

  // Issues
  $open_bugs = 0;
  foreach($dom2->find("div.issue-cockpit-bug div.issue-cockpit-totals a") as $data2){
    if (empty($open_bugs) && stristr($data2->plaintext, "open")) {
      $open_bugs = intval(str_ireplace(' open', '', $data2->plaintext));
    }
  }

  // Commit stats
  // ex: "last: 9 weeks ago, first: 1 year ago"
  $last_commit = NULL;
  foreach($dom2->find("div.vc-commit-times") as $data2) {
    $commits = preg_split('@\,\s*@', $data2->plaintext, 2);
    foreach ($commits as $commit_i => $commit) {
      if (stripos($commit, 'last') !== FALSE) {
        $last_commit = preg_replace('@^.*\:\s*@', '', $commit);
        if (!empty($last_commit)) {
          $last_commit = date_create($last_commit);
        }
        break;
      }
    }

    break;
  }
  // Last modified
  if (is_object($lastmodified)) { 
  if (is_object($last_commit)) { if ($last_commit->format("U") > $lastmodified->format("U")) {
    $lastmodified = $last_commit;
    if ($testing) { echo "The last commit ".$last_commit->format("m/d/Y")." is sooner than page update ".$lastmodified->format("m/d/Y")."\n"; }
  }}
  if (is_object($rec_release['timestamp'])) { if ($rec_release['timestamp']->format("U") > $lastmodified->format("U")) {
    $lastmodified = $rec_release['timestamp'];
    if ($testing) { echo "The rec release ".$rec_release['timestamp']->format("m/d/Y")." is sooner than page update ".$lastmodified->format("m/d/Y")."\n"; }
  }}
  } elseif (is_object($created)) {
    $lastmodified = $created;
  }

  // Status
  /* We only want four statuses:
   * 1) Recommended (is not sandbox, has beta, rc or stable release)
   * 2) Active (has any recommended release)
   * 3) In-Development (default)
   * 4) Not Recommended (Obsolete, Unsupported)
   */
  $status = "In Development";
  if ($module_pg_type != "Sandbox" && ($rec_release['type'] == "beta" || $rec_release['type'] == "rc" || $rec_release['type'] == "stable")) {
    $status = "Recommended";
  } elseif ($module_pg_type != "Sandbox" && !empty($rec_release['type'])) {
    $status = "Active";
  } elseif ($dev_status=="Obsolete" || $maintenance_status == "Unsupported") {
    $status = "Not Recommended";
  }

  // Build data record
  $uniquekeys = array("url");
  $data_row = array(
    "name" => $title,
    "url" => str_replace("http://drupal.org/project/","",$url),
    "author" => $author,
    "status" => $status,
    "downloads" => $downloads,
    "installs" => $installs,
    "bugs" => $open_bugs,
    "created" => $created,
    "modified" => $lastmodified,
    "images" => $module_img,
    "description" => $desc,
    "module_pg_type" => $module_pg_type,
  );
  if ($testing) {
    print_r($data_row);
  } else {
    scraperwiki::save($uniquekeys,$data_row);
  }
}
?>
<?php
$testing = false;

$page = array(
  array("type" => "Sandbox","url" => "http://drupal.org/project/modules/commerce%20-ubercart%20-%22e-commerce%22%20-deprecated%20-uc%20-Ubercart%20-%22Commerce%20Sandbox%22%20-deleted%20-eCommerce?f[0]=bs_project_sandbox%3A1","multiple_results"=>true),
  array("type" => "Sandbox","url" => "http://drupal.org/project/modules/commerce%20-ubercart%20-%22e-commerce%22%20-deprecated%20-uc%20-Ubercart%20-%22Commerce%20Sandbox%22%20-deleted%20-eCommerce?page=1&f[0]=bs_project_sandbox%3A1","multiple_results"=>true),
  array("type" => "Sandbox","url" => "http://drupal.org/project/modules/commerce%20-ubercart%20-%22e-commerce%22%20-deprecated%20-uc%20-Ubercart%20-%22Commerce%20Sandbox%22%20-deleted%20-eCommerce?page=2&f[0]=bs_project_sandbox%3A1","multiple_results"=>true),
  array("type" => "Sandbox","url" => "http://drupal.org/project/modules/commerce%20-ubercart%20-%22e-commerce%22%20-deprecated%20-uc%20-Ubercart%20-%22Commerce%20Sandbox%22%20-deleted%20-eCommerce?page=3&f[0]=bs_project_sandbox%3A1","multiple_results"=>true),
  array("type" => "Sandbox","url" => "http://drupal.org/project/modules/commerce%20-ubercart%20-%22e-commerce%22%20-deprecated%20-uc%20-Ubercart%20-%22Commerce%20Sandbox%22%20-deleted%20-eCommerce?page=4&f[0]=bs_project_sandbox%3A1","multiple_results"=>true),
  array("type" => "Sandbox","url" => "http://drupal.org/project/modules/commerce%20-ubercart%20-%22e-commerce%22%20-deprecated%20-uc%20-Ubercart%20-%22Commerce%20Sandbox%22%20-deleted%20-eCommerce?page=5&f[0]=bs_project_sandbox%3A1","multiple_results"=>true),
  array("type" => "Sandbox","url" => "http://drupal.org/project/modules/commerce%20-ubercart%20-%22e-commerce%22%20-deprecated%20-uc%20-Ubercart%20-%22Commerce%20Sandbox%22%20-deleted%20-eCommerce?page=6&f[0]=bs_project_sandbox%3A1","multiple_results"=>true),
  array("type" => "Sandbox","url" => "http://drupal.org/project/modules/commerce%20-ubercart%20-%22e-commerce%22%20-deprecated%20-uc%20-Ubercart%20-%22Commerce%20Sandbox%22%20-deleted%20-eCommerce?page=7&f[0]=bs_project_sandbox%3A1","multiple_results"=>true),
  array("type" => "Sandbox","url" => "http://drupal.org/project/modules/commerce%20-ubercart%20-%22e-commerce%22%20-deprecated%20-uc%20-Ubercart%20-%22Commerce%20Sandbox%22%20-deleted%20-eCommerce?page=8&f[0]=bs_project_sandbox%3A1","multiple_results"=>true),
  array("type" => "Sandbox","url" => "http://drupal.org/project/modules/commerce%20-ubercart%20-%22e-commerce%22%20-deprecated%20-uc%20-Ubercart%20-%22Commerce%20Sandbox%22%20-deleted%20-eCommerce?page=9&f[0]=bs_project_sandbox%3A1","multiple_results"=>true),
  array("type" => "Sandbox","url" => "http://drupal.org/project/modules/commerce%20-ubercart%20-%22e-commerce%22%20-deprecated%20-uc%20-Ubercart%20-%22Commerce%20Sandbox%22%20-deleted%20-eCommerce?page=10&f[0]=bs_project_sandbox%3A1","multiple_results"=>true),
  array("type" => "Sandbox","url" => "http://drupal.org/project/modules/commerce%20-ubercart%20-%22e-commerce%22%20-deprecated%20-uc%20-Ubercart%20-%22Commerce%20Sandbox%22%20-deleted%20-eCommerce?page=11&f[0]=bs_project_sandbox%3A1","multiple_results"=>true),
  array("type" => "Sandbox","url" => "http://drupal.org/project/modules/commerce%20-ubercart%20-%22e-commerce%22%20-deprecated%20-uc%20-Ubercart%20-%22Commerce%20Sandbox%22%20-deleted%20-eCommerce?page=12&f[0]=bs_project_sandbox%3A1","multiple_results"=>true),
  array("type" => "Distribution","url" => "http://drupal.org/project/distributions/commerce?f[0]=drupal_core%3A103&f[1]=bs_project_sandbox%3A0","multiple_results"=>true),
  array("type" => "Theme","url" => "http://drupal.org/search/site/commerce?f[0]=drupal_core%3A103&f[1]=bs_project_sandbox%3A0&f[2]=ss_meta_type%3Atheme","multiple_results"=>true),
  array("type" => "Module","url" => "http://drupal.org/search/site/commerce?f[0]=drupal_core%3A103&f[1]=bs_project_sandbox%3A0&f[2]=ss_meta_type%3Amodule","multiple_results"=>true),
  array("type" => "Module","url" => "http://drupal.org/search/site/commerce?page=1&f[0]=drupal_core%3A103&f[1]=bs_project_sandbox%3A0&f[2]=ss_meta_type%3Amodule","multiple_results"=>true),
  array("type" => "Module","url" => "http://drupal.org/search/site/commerce?page=2&f[0]=drupal_core%3A103&f[1]=bs_project_sandbox%3A0&f[2]=ss_meta_type%3Amodule","multiple_results"=>true),
  array("type" => "Module","url" => "http://drupal.org/search/site/commerce?page=3&f[0]=drupal_core%3A103&f[1]=bs_project_sandbox%3A0&f[2]=ss_meta_type%3Amodule","multiple_results"=>true),
  array("type" => "Module","url" => "http://drupal.org/search/site/commerce?page=4&f[0]=drupal_core%3A103&f[1]=bs_project_sandbox%3A0&f[2]=ss_meta_type%3Amodule","multiple_results"=>true),
  array("type" => "Module","url" => "http://drupal.org/search/site/commerce?page=5&f[0]=drupal_core%3A103&f[1]=bs_project_sandbox%3A0&f[2]=ss_meta_type%3Amodule","multiple_results"=>true),
  array("type" => "Module","url" => "http://drupal.org/search/site/commerce?page=6&f[0]=drupal_core%3A103&f[1]=bs_project_sandbox%3A0&f[2]=ss_meta_type%3Amodule","multiple_results"=>true),
  array("type" => "Module","url" => "http://drupal.org/search/site/commerce?page=7&f[0]=drupal_core%3A103&f[1]=bs_project_sandbox%3A0&f[2]=ss_meta_type%3Amodule","multiple_results"=>true),
  array("type" => "Module","url" => "http://drupal.org/search/site/commerce?page=8&f[0]=drupal_core%3A103&f[1]=bs_project_sandbox%3A0&f[2]=ss_meta_type%3Amodule","multiple_results"=>true),
  array("type" => "Module","url" => "http://drupal.org/search/site/commerce?page=9&f[0]=drupal_core%3A103&f[1]=bs_project_sandbox%3A0&f[2]=ss_meta_type%3Amodule","multiple_results"=>true),
  array("type" => "Module","url" => "http://drupal.org/search/site/commerce?page=10&f[0]=drupal_core%3A103&f[1]=bs_project_sandbox%3A0&f[2]=ss_meta_type%3Amodule","multiple_results"=>true),
  array("type" => "Module","url" => "http://drupal.org/search/site/commerce?page=11&f[0]=drupal_core%3A103&f[1]=bs_project_sandbox%3A0&f[2]=ss_meta_type%3Amodule","multiple_results"=>true),
  array("type" => "Module","url" => "http://drupal.org/search/site/commerce?page=12&f[0]=drupal_core%3A103&f[1]=bs_project_sandbox%3A0&f[2]=ss_meta_type%3Amodule","multiple_results"=>true),
  array("type" => "Module","url" => "http://drupal.org/search/site/commerce?page=13&f[0]=drupal_core%3A103&f[1]=bs_project_sandbox%3A0&f[2]=ss_meta_type%3Amodule","multiple_results"=>true),
  array("type" => "Module","url" => "http://drupal.org/search/site/commerce?page=14&f[0]=drupal_core%3A103&f[1]=bs_project_sandbox%3A0&f[2]=ss_meta_type%3Amodule","multiple_results"=>true),
  array("type" => "Module","url" => "http://drupal.org/project/inline_entity_form","multiple_results"=>false),
  array("type" => "Module","url" => "http://drupal.org/project/addressfield","multiple_results"=>false),
  array("type" => "Module","url" => "http://drupal.org/project/physical","multiple_results"=>false),
  array("type" => "Module","url" => "http://drupal.org/project/views","multiple_results"=>false),
  array("type" => "Module","url" => "http://drupal.org/project/rules","multiple_results"=>false),
  array("type" => "Module","url" => "http://drupal.org/project/entity","multiple_results"=>false),
  array("type" => "Module","url" => "http://drupal.org/project/tree","multiple_results"=>false),
  array("type" => "Module","url" => "http://drupal.org/project/facetapi","multiple_results"=>false),
  array("type" => "Module","url" => "http://drupal.org/project/search_api","multiple_results"=>false),
  array("type" => "Module","url" => "http://drupal.org/project/editablefields","multiple_results"=>false),
  array("type" => "Module","url" => "http://drupal.org/project/jirafe","multiple_results"=>false),
  array("type" => "Module","url" => "http://drupal.org/project/yottaa","multiple_results"=>false),
  array("type" => "Module","url" => "http://drupal.org/project/dc_cart_ajax","multiple_results"=>false),
  array("type" => "Module","url" => "http://drupal.org/project/commerce_product_clone","multiple_results"=>false),
  array("type" => "Module","url" => "http://drupal.org/project/product_reference_view","multiple_results"=>false),
  array("type" => "Module","url" => "http://drupal.org/project/dc_co_pages","multiple_results"=>false),
  array("type" => "Sandbox","url" => "http://drupal.org/sandbox/webmasterkai/1305710","multiple_results"=>false),
  array("type" => "Sandbox","url" => "http://drupal.org/sandbox/webmasterkai/1313714","multiple_results"=>false),
  array("type" => "Theme","url" => "http://drupal.org/project/corporateclean","multiple_results"=>false),
  array("type" => "Theme","url" => "http://drupal.org/project/bluemasters","multiple_results"=>false),
  array("type" => "Theme","url" => "http://drupal.org/project/sky","multiple_results"=>false),
  array("type" => "Theme","url" => "http://drupal.org/project/business","multiple_results"=>false),
  array("type" => "Theme","url" => "http://drupal.org/project/andromeda","multiple_results"=>false),
  array("type" => "Theme","url" => "http://drupal.org/project/touch","multiple_results"=>false),
  array("type" => "Theme","url" => "http://drupal.org/project/busy","multiple_results"=>false),
  array("type" => "Theme","url" => "http://drupal.org/project/jackson","multiple_results"=>false),
  array("type" => "Module","url" => "http://drupal.org/project/goals","multiple_results"=>false),
  array("type" => "Module","url" => "http://drupal.org/project/rules_linkevent","multiple_results"=>false),
  array("type" => "Module","url" => "http://drupal.org/project/customer_profile_type_ui","multiple_results"=>false)
);       
require 'scraperwiki/simple_html_dom.php';



if ($testing) {
  $limit = 2;
  $Module = 0;
  $Theme = 0;
  $Sandbox = 0;
  $Distribution = 0;

} else {

  // Each run is unique, start fresh (a bit scary)
  if (scraperwiki::table_info('swdata')) {
    scraperwiki::sqliteexecute("drop table swdata");
  }

  // To change schema:
  // - Clear data
  // - Run
  if (!scraperwiki::table_info('swdata')) {
    scraperwiki::sqliteexecute("create table swdata (`module_pg_type` varchar, `name` varchar, `description` text, `url` varchar, `author` varchar, `status` varchar, `modified` datetime, `downloads` int, `installs` int, `bugs` int, `created` datetime, `images` varchar)");
    scraperwiki::sqlitecommit();
  }
  //exit;
}

$now = time();

foreach ($page as $url) {
  if ($testing && !$url['multiple_results'] && $$url['type'] < $limit) {
    echo "We are parsing: ".print_r($url,true)."\n";
    $html = scraperWiki::scrape($url['url']);
    $dom = new simple_html_dom();
    $dom->load($html);
  } elseif (!$testing) {
    $html = scraperWiki::scrape($url['url']);
    $dom = new simple_html_dom();
    $dom->load($html);
  }
  if ($url['multiple_results'] && !$testing) {
    switch ($url['type']) {
      case "Module":
        foreach($dom->find("dt[@class='title'] a") as $data) {
          if (stristr($data->href,"commerce_") || stristr($data->href,"_commerce")) {
            $html2 = scraperWiki::scrape($data->href);
            $dom2 = new simple_html_dom();
            $dom2->load($html2);
            parse_commerce_page($dom2,$data->plaintext,$data->href,$url['type']);
          }
        }
        break;
      case "Theme":
        foreach($dom->find("dt[@class='title'] a") as $data) {
          $html2 = scraperWiki::scrape($data->href);
          $dom2 = new simple_html_dom();
          $dom2->load($html2);
          parse_commerce_page($dom2,$data->plaintext,$data->href,$url['type']);
        }
        break;
      case "Distribution":
        foreach($dom->find("h2[@class='title'] a") as $data) {
          $html2 = scraperWiki::scrape("http://drupal.org".$data->href);
          $dom2 = new simple_html_dom();
          $dom2->load($html2);
          parse_commerce_page($dom2,$data->plaintext,"http://drupal.org".$data->href,$url['type']);
        }
        break;
      case "Sandbox":
        foreach($dom->find("h2[@class='title'] a") as $data) {
          $html2 = scraperWiki::scrape("http://drupal.org".$data->href);
          $dom2 = new simple_html_dom();
          $dom2->load($html2);
          parse_commerce_page($dom2,$data->plaintext,"http://drupal.org".$data->href,$url['type']);
        }
        break;
    } 
  } elseif (!$url['multiple_results']) {
    if ($testing && $$url['type'] < $limit) {
      $$url['type']++;
      echo "Testing a ".$url['type']."\n";
    } elseif ($testing && $$url['type'] >= $limit) {
      continue;
    }
    foreach($dom->find("h1[@id='page-subtitle']") as $data) {
      $title = $data->plaintext;
      if ($url['type']=="Sandbox") {
        $title = explode(":",$title);
        $title = $title[1];
      }
      break;
    }
    if ($testing) { echo "About to parse the ".$url['type']."\n"; }
    parse_commerce_page($dom,$title,$url['url'],$url['type'],$testing);
  }
}

function parse_commerce_page ($dom2,$title,$url,$module_pg_type="Module",$testing=false) {
  global $now;
    
  // author
  $author = "";
  foreach($dom2->find("div[@class='submitted'] a") as $data2){
    $author = $data2->plaintext;
    break;
  }

  // module images
  $module_img = false;
  foreach($dom2->find("div[@class='field-field-project-images'] div[@class='field-item'] a") as $data2) {
    if (!$module_img) $module_img = array();
    //$module_img[] = trim($data2->href);
    $module_img = trim($data2->href);
    break;
  }
  //if ($module_img !== false){
  //  $module_img = implode(", ",$module_img);
  //}

  // created
  $created= NULL;
  foreach($dom2->find("div[@class='submitted'] em") as $data2){
    $created = str_ireplace(' at ', ' ', $data2->plaintext);
    if (!empty($created)) {
      $created = date_create($created);
    }

    break;
  }

  // description
  $desc="";
  foreach($dom2->find("div[@class='node-content'] p") as $data2){
    // get sentences
    $sentences = preg_split('/(?<=[.!?]|[.!?][\'"])\s+/', $data2->plaintext, -1, PREG_SPLIT_NO_EMPTY);
    
    // go through each sentence, avoid if it's the disclaimer or headline, let it iterate to another paragraph
    foreach ($sentences as $sentence) {
      if (
        !stristr(@$sentence,"This is a sandbox project") && 
        !stristr(@$sentence,"Git repository") && 
        strncmp(strtolower($sentence), "overview", 8) !== 0 && 
        strncmp(strtolower($sentence), "description", 11) !== 0 &&
        strlen($desc) < 350){
        $desc .= @$sentence . " ";
      }
    }
    if (strlen($desc) > 350) break;
  }
  $desc = trim($desc);

  // module stats
  $maintenance_status = "";
  $dev_status = "";
  $installs = 0;
  $downloads = 0;
  $lastmodified = "";
  foreach($dom2->find("div[@class='project-info'] ul li") as $data2){
    if (stristr($data2->plaintext,"Maintenance")) {
      $maintenance_status = substr($data2->plaintext,20);
    }
    if (stristr($data2->plaintext,"Development")) {
      $dev_status = substr($data2->plaintext,20);
    }
    if (stristr($data2->plaintext,"Reported")) {
      $array = explode(" ",$data2->plaintext);
      $installs = intval(str_replace(",","",$array[2]));
    }
    if (stristr($data2->plaintext,"Downloads")) {
      $array = explode(" ",$data2->plaintext);
      $downloads = intval(str_replace(",","",$array[1]));
    }
    if (stristr($data2->plaintext,"Last")) {
      $lastmodified = date_create(substr($data2->plaintext,15));
    }
  }

  // Stable releases
  $rec_release = array('version' => '', 'type' => '', 'timestamp' => NULL);      
  foreach($dom2->find("div.download-table-ok tr.views-row-first") as $data2){
    foreach ($data2->find('td.views-field-version a') as $release_data) {
      $rec_release['version'] = $release_data->plaintext;
      // resolve type of release
      //7.x-1.0-beta4
      $version_parts = explode('-', $rec_release['version']);
      if (!empty($version_parts)) {
        $rec_release['type'] = 'unknown';
        $version_parts_count = count($version_parts);
        if (count($version_parts) > 2) {
          $last_version_part = $version_parts[$version_parts_count - 1];
          foreach (array('beta', 'alpha', 'rc') as $version_type) {
            if (stripos($last_version_part, $version_type) !== FALSE) {
              $rec_release['type'] = $version_type;
              break;
            }
          }
        }
        else {
         $rec_release['type'] = 'stable';
        }
      }

      break;
    }
    foreach ($data2->find('td.views-field-file-timestamp') as $release_data) {
      $rec_release['timestamp'] = date_create($release_data->plaintext);
      break;
    }

    break;
  }

  // Issues
  $open_bugs = 0;
  foreach($dom2->find("div.issue-cockpit-bug div.issue-cockpit-totals a") as $data2){
    if (empty($open_bugs) && stristr($data2->plaintext, "open")) {
      $open_bugs = intval(str_ireplace(' open', '', $data2->plaintext));
    }
  }

  // Commit stats
  // ex: "last: 9 weeks ago, first: 1 year ago"
  $last_commit = NULL;
  foreach($dom2->find("div.vc-commit-times") as $data2) {
    $commits = preg_split('@\,\s*@', $data2->plaintext, 2);
    foreach ($commits as $commit_i => $commit) {
      if (stripos($commit, 'last') !== FALSE) {
        $last_commit = preg_replace('@^.*\:\s*@', '', $commit);
        if (!empty($last_commit)) {
          $last_commit = date_create($last_commit);
        }
        break;
      }
    }

    break;
  }
  // Last modified
  if (is_object($lastmodified)) { 
  if (is_object($last_commit)) { if ($last_commit->format("U") > $lastmodified->format("U")) {
    $lastmodified = $last_commit;
    if ($testing) { echo "The last commit ".$last_commit->format("m/d/Y")." is sooner than page update ".$lastmodified->format("m/d/Y")."\n"; }
  }}
  if (is_object($rec_release['timestamp'])) { if ($rec_release['timestamp']->format("U") > $lastmodified->format("U")) {
    $lastmodified = $rec_release['timestamp'];
    if ($testing) { echo "The rec release ".$rec_release['timestamp']->format("m/d/Y")." is sooner than page update ".$lastmodified->format("m/d/Y")."\n"; }
  }}
  } elseif (is_object($created)) {
    $lastmodified = $created;
  }

  // Status
  /* We only want four statuses:
   * 1) Recommended (is not sandbox, has beta, rc or stable release)
   * 2) Active (has any recommended release)
   * 3) In-Development (default)
   * 4) Not Recommended (Obsolete, Unsupported)
   */
  $status = "In Development";
  if ($module_pg_type != "Sandbox" && ($rec_release['type'] == "beta" || $rec_release['type'] == "rc" || $rec_release['type'] == "stable")) {
    $status = "Recommended";
  } elseif ($module_pg_type != "Sandbox" && !empty($rec_release['type'])) {
    $status = "Active";
  } elseif ($dev_status=="Obsolete" || $maintenance_status == "Unsupported") {
    $status = "Not Recommended";
  }

  // Build data record
  $uniquekeys = array("url");
  $data_row = array(
    "name" => $title,
    "url" => str_replace("http://drupal.org/project/","",$url),
    "author" => $author,
    "status" => $status,
    "downloads" => $downloads,
    "installs" => $installs,
    "bugs" => $open_bugs,
    "created" => $created,
    "modified" => $lastmodified,
    "images" => $module_img,
    "description" => $desc,
    "module_pg_type" => $module_pg_type,
  );
  if ($testing) {
    print_r($data_row);
  } else {
    scraperwiki::save($uniquekeys,$data_row);
  }
}
?>
